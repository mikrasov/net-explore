var ip_list = ['188.1.33.118','202.112.61.162','188.1.33.117','190.220.179.202','83.167.63.140','190.220.179.201','4.69.144.11','129.250.2.183','4.69.140.6','203.188.117.129','192.31.99.161','202.179.241.78','202.179.241.77','210.25.189.46','210.25.189.49','10.0.1.29','134.75.105.2','83.167.63.150','157.92.44.101','193.251.132.150','150.99.199.93','150.99.2.57','128.111.252.168','128.111.252.169','154.54.10.134','150.99.2.58','150.99.199.94','192.31.99.170','150.99.2.50','150.99.2.53','150.99.2.54','202.179.241.50','210.25.189.50','80.150.170.126','137.164.26.26','137.164.26.25','137.164.47.25','116.89.165.133','150.99.2.86','150.99.2.85','150.99.2.82','150.99.2.81','210.25.189.65','188.1.145.129','195.83.166.161','195.83.166.162','172.19.10.33','203.188.117.137','203.188.117.138','172.19.10.37','188.1.145.130','83.167.55.87','202.14.80.155','202.112.53.50','150.99.2.73','202.179.241.46','150.99.2.74','202.179.241.45','203.188.117.130','203.188.117.133','202.14.80.153','203.188.117.134','101.4.115.169','141.20.0.65','141.20.0.66','132.65.240.1','202.112.61.122','4.68.63.242','202.179.241.30','101.4.116.146','62.40.98.128','101.4.116.145','172.19.10.82','62.40.98.129','66.110.57.90','150.99.2.21','193.159.166.10','117.103.111.153','101.4.115.170','83.167.55.76','193.251.240.225','146.97.130.2','146.97.130.1','150.99.2.22','101.4.115.174','101.4.115.173','80.91.245.123','4.69.148.106','137.164.47.72','134.75.105.49','101.4.116.134','202.179.241.25','101.4.116.133','202.179.241.29','202.179.241.26','192.5.89.222','62.40.98.114','128.103.0.17','101.4.116.138','62.40.98.115','128.103.0.18','192.5.89.221','195.83.166.178','4.69.144.75','62.40.125.241','202.112.61.105','202.112.61.106','62.40.125.242','62.40.98.108','62.40.98.109','64.57.28.198','150.99.2.49','64.57.28.199','188.1.145.186','188.1.145.185','80.77.1.13','80.91.245.117','4.69.143.214','101.4.116.117','101.4.116.118','128.111.252.149','66.110.57.81','150.99.2.34','150.99.2.33','128.111.252.148','4.69.143.218','61.14.157.1','201.125.198.217','130.133.252.49','152.63.84.182','169.232.4.106','169.232.4.107','130.133.252.53','169.232.4.102','169.232.4.103','130.133.252.58','169.232.4.101','152.63.85.94','83.167.55.22','200.0.204.97','129.250.4.38','139.19.158.225','152.63.85.90','152.179.21.42','154.54.2.114','216.24.184.86','216.24.184.85','175.45.11.98','175.45.11.97','140.247.2.61','61.14.157.6','61.14.157.5','140.247.2.62','152.63.81.10','128.111.52.64','128.111.52.63','152.63.81.14','152.63.80.26','128.111.52.58','150.99.200.193','64.57.28.160','140.247.2.34','150.99.200.194','140.247.2.33','140.247.60.126','195.2.28.154','137.164.24.134','137.164.24.135','130.216.1.125','4.69.144.139','4.69.144.138','4.69.132.86','213.155.132.211','200.0.204.62','80.91.253.117','200.0.204.63','200.0.204.60','154.54.6.38','200.0.204.61','154.54.6.34','154.54.6.118','192.86.163.41','192.86.163.42','192.86.163.45','134.159.174.41','213.248.76.189','213.155.132.209','192.86.163.46','154.54.7.46','4.69.134.21','4.69.132.77','200.0.204.58','193.51.181.221','137.164.23.8','200.0.204.57','66.110.56.6','195.2.30.46','200.0.204.59','129.250.9.117','200.0.204.56','134.159.174.37','172.16.4.1','154.54.6.106','172.16.4.6','4.69.201.65','202.112.27.150','210.25.189.18','210.25.189.17','64.57.28.112','188.1.145.102','188.1.145.101','64.57.28.113','67.16.147.129','67.16.147.130','154.54.6.54','202.112.53.18','202.84.143.25','202.112.27.141','146.97.37.185','146.97.37.186','4.59.48.177','4.59.48.178','170.51.254.166','210.25.189.22','67.16.147.141','67.16.147.142','193.251.128.182','210.25.189.25','154.54.24.82','202.112.61.197','80.91.249.202','202.112.61.198','203.167.201.41','203.181.248.126','67.16.164.190','188.1.144.18','188.1.144.17','188.1.144.14','168.96.0.5','188.1.144.13','200.0.204.13','4.69.137.77','200.0.204.14','202.84.251.242','137.164.26.134','154.54.44.210','188.1.231.10','207.231.240.129','172.19.10.146','207.231.240.131','137.164.24.189','4.69.137.65','4.69.137.61','203.181.248.141','198.32.11.105','198.32.11.106','203.181.248.142','130.149.49.1','146.97.33.41','192.86.163.150','203.192.137.209','203.181.248.109','129.250.3.15','152.63.80.98','128.111.4.52','128.111.4.53','66.110.59.1','4.69.137.53','203.192.134.65','202.40.138.149','4.69.137.57','203.192.134.66','137.164.25.38','203.181.248.110','62.40.98.76','62.40.98.77','64.57.28.46','190.220.179.70','137.164.25.33','64.57.28.47','141.20.100.1','131.179.150.70','200.0.204.41','213.155.137.89','210.7.36.225','200.0.204.42','4.69.137.49','62.40.98.80','62.40.98.81','203.181.248.121','190.220.179.66','203.192.134.70','203.181.248.122','157.159.224.41','101.4.114.234','77.67.68.233','157.159.224.42','115.160.187.31','61.14.157.137','129.250.232.6','188.1.234.37','187.174.64.17','188.1.234.38','130.133.252.242','10.255.249.249','202.40.161.227','83.167.55.148','199.248.144.246','10.255.249.254','199.248.144.245','200.0.204.145','200.0.204.146','157.159.224.34','157.159.224.33','195.2.28.49','130.117.50.198','203.181.248.101','203.181.248.102','202.112.28.97','202.112.28.98','202.179.249.53','63.145.224.13','216.6.84.53','152.63.84.198','152.63.84.194','210.25.189.173','130.149.126.58','130.149.126.57','157.159.226.1','108.59.31.22','108.59.31.20','188.1.144.21','188.1.144.22','157.238.179.126','139.19.158.252','115.160.187.40','152.63.80.70','85.95.26.90','130.133.116.2','80.91.251.99','188.1.144.230','190.220.176.33','108.59.26.4','62.40.98.153','195.2.25.210','154.54.27.182','188.1.144.229','195.2.22.37','190.220.176.25','195.66.224.42','154.54.30.206','137.164.47.137','137.164.47.138','137.164.47.136','154.54.5.114','80.91.245.66','137.164.47.139','188.1.145.98','188.1.145.97','213.155.137.26','129.250.6.115','213.155.137.22','200.0.204.102','129.250.6.114','212.162.4.6','4.69.143.93','212.162.4.9','130.149.126.17','210.25.189.138','62.40.124.197','4.69.148.241','210.25.189.137','188.1.145.81','62.40.124.198','210.25.189.134','210.25.189.133','137.164.47.132','101.4.116.154','64.57.21.209','101.4.116.153','80.77.0.182','137.164.47.125','128.232.103.194','188.1.145.82','62.40.125.17','63.65.188.142','62.40.125.18','210.25.189.129','4.69.148.253','192.203.116.148','129.250.2.9','67.16.142.42','133.68.253.242','133.68.253.241','152.63.86.86','63.235.40.54','129.250.4.5','62.216.128.65','80.91.254.215','63.146.27.130','194.57.241.203','62.216.128.62','194.57.241.204','80.91.251.76','80.239.128.181','192.203.116.154','62.40.98.152','4.69.137.30','149.11.114.86','62.40.124.138','194.25.211.22','62.40.124.137','146.97.33.18','210.7.36.227','81.52.179.194','192.203.116.145','146.97.33.26','192.203.116.146','152.63.86.26','62.40.98.66','169.232.4.49','62.40.98.65','152.63.86.22','62.40.98.64','203.181.248.185','128.103.0.2','128.103.0.1','4.69.137.22','154.54.5.158','62.40.98.67','146.97.33.30','169.232.4.55','169.232.4.56','203.181.248.154','169.232.4.58','4.69.137.18','169.232.4.51','213.155.130.86','137.164.27.6','137.164.27.5','134.75.105.97','62.153.203.205','188.1.144.225','188.1.144.226','4.69.154.137','131.179.150.4','62.40.125.66','193.60.89.9','146.97.33.17','46.255.177.163','62.40.125.65','146.97.33.10','152.63.86.34','193.60.89.2','150.99.188.201','150.99.188.202','137.164.26.133','80.150.170.165','157.159.11.40','207.231.240.136','152.63.84.202','207.231.240.135','207.231.240.138','206.82.129.57','152.63.84.206','67.16.156.138','207.231.240.144','192.84.5.93','192.84.5.94','192.84.5.98','137.164.26.6','137.164.26.5','202.84.140.181','67.16.156.118','207.231.240.154','117.103.111.205','149.6.164.86','188.1.234.174','10.0.1.2','194.25.6.74','101.4.112.2','140.247.3.61','140.247.3.62','198.32.176.95','198.32.11.50','202.84.142.106','10.0.1.1','198.32.11.51','202.84.142.110','207.231.240.22','130.133.99.6','130.133.99.98','152.63.84.218','67.16.132.10','152.63.84.214','205.171.234.102','198.32.252.238','192.84.5.137','152.63.84.210','202.84.142.118','192.84.5.138','117.103.111.222','101.4.112.1','38.122.92.105','117.103.111.226','130.216.1.22','213.248.84.177','154.54.42.10','202.112.61.9','132.65.240.100','202.112.27.225','132.65.240.101','202.112.27.226','61.14.157.94','205.158.79.202','152.63.86.10','4.69.143.137','216.24.184.149','194.25.6.86','4.69.143.141','202.112.61.38','202.112.61.37','4.69.143.145','62.40.125.102','62.40.125.101','202.112.61.10','202.112.61.13','213.155.135.13','4.69.154.72','61.8.59.38','80.91.246.105','192.5.89.98','192.5.89.97','140.247.3.33','140.247.3.34','213.155.134.117','157.159.226.72','195.10.54.66','198.71.45.49','202.112.61.14','202.112.61.18','4.69.159.62','154.54.59.30','216.24.186.72','4.69.159.50','216.24.186.71','216.24.186.70','210.7.32.10','4.69.159.58','4.69.159.54','190.220.179.189','216.24.186.79','216.24.186.78','216.24.186.75','216.24.186.73','137.164.23.90','130.133.99.29','137.164.23.91','188.1.144.189','213.155.135.199','188.1.144.186','213.155.135.197','213.155.135.193','128.111.52.1','202.169.174.38','188.1.144.185','4.69.159.42','202.112.42.2','157.92.44.97','202.112.42.5','202.112.42.6','154.54.59.18','154.54.30.66','64.208.27.210','216.24.186.84','216.24.186.85','216.24.186.86','202.112.42.1','216.24.186.87','188.1.144.158','216.24.186.90','141.20.103.210','188.1.144.157','67.16.145.117','216.24.186.91','10.0.13.2','10.0.13.1','4.69.159.34','4.69.159.38','188.1.235.118','207.210.143.54','207.210.143.53','188.1.235.117','188.1.146.137','188.1.146.138','202.112.27.69','152.63.51.57','61.14.157.78','195.50.119.98','188.1.146.134','188.1.146.133','129.250.2.12','132.64.1.62','62.40.112.146','62.40.112.145','130.117.1.222','193.51.189.202','137.164.46.102','154.54.12.106','130.117.2.158','129.250.2.45','157.92.47.2','157.92.47.1','4.68.111.22','154.54.84.53','154.54.84.57','129.250.2.36','129.250.2.37','207.210.142.253','172.16.3.1','152.63.80.102','216.24.186.48','216.24.186.49','152.63.115.190','172.16.3.2','211.68.70.40','64.57.29.197','216.24.186.50','188.1.144.190','192.5.89.22','216.24.186.59','192.5.89.21','216.24.186.53','216.24.186.54','216.24.186.51','216.24.186.52','216.24.186.57','216.24.186.55','213.248.100.50','200.0.207.10','190.220.179.190','202.147.50.198','202.147.50.197','190.220.179.193','154.54.30.54','211.68.70.33','216.24.186.61','216.24.186.60','129.250.3.73','61.252.49.5','192.5.89.17','192.5.89.18','129.250.3.77','129.250.5.217','205.171.234.98','190.220.179.197','193.51.189.241','4.69.140.14','216.24.186.62','216.24.186.63','193.51.189.242','190.220.179.198','4.69.154.9','216.24.186.66','4.69.140.10','216.24.186.67','216.24.186.68','202.112.6.90','154.54.44.106','101.4.116.69','83.167.63.231','134.159.61.22','66.110.56.138','101.4.112.41','188.1.144.102','101.4.112.45','101.4.112.42','128.103.0.146','128.103.0.145','101.4.112.46','188.1.144.101','202.40.149.230','195.2.10.145','202.112.6.89','193.60.89.10','132.64.252.26','132.64.252.25','63.145.1.133','101.4.116.70','154.54.6.69','190.220.179.29','202.179.249.117','128.103.0.130','62.40.124.218','62.40.124.217','101.4.116.82','129.250.3.180','83.167.56.221','101.4.116.81','128.103.0.129','207.231.245.22','157.159.11.1','137.164.27.13','202.112.36.69','154.54.6.73','101.4.112.37','80.91.252.162','10.169.39.209','101.4.112.38','129.250.2.98','130.133.99.102','169.232.12.155','130.149.49.136','169.232.12.156','202.40.161.23','4.69.134.130','202.179.241.101','188.1.144.141','4.69.134.134','188.1.144.142','137.164.46.134','137.164.46.135','137.164.46.132','143.89.50.252','137.164.46.133','202.179.241.106','129.250.3.174','129.250.3.175','4.69.134.142','4.69.134.145','129.250.3.172','101.4.112.98','4.69.134.149','101.4.112.97','64.57.28.9','101.4.112.62','64.57.28.8','101.4.112.61','129.250.6.209','62.40.124.69','4.69.140.97','193.251.243.42','128.232.103.201','129.250.5.24','157.92.47.98','4.69.134.153','132.64.252.58','188.1.144.121','188.1.144.122','101.4.112.69','188.1.144.125','188.1.144.126','132.64.252.57','62.40.124.70','101.4.112.70','154.54.46.218','154.54.28.77','139.68.253.242','129.250.3.154','203.131.246.154','203.131.246.153','203.181.249.81','198.71.45.25','143.89.49.72','198.71.45.21','143.89.49.73','198.71.45.20','154.54.28.65','160.45.252.102','137.164.46.97','195.2.28.1','202.40.161.53','134.96.6.25','134.96.6.28','129.250.2.120','210.7.36.186','139.19.0.139','129.250.3.126','139.19.0.138','67.16.145.53','154.54.5.218','210.7.36.1','210.7.36.185','62.154.14.106','207.231.241.22','62.154.14.110','67.17.108.62','129.250.2.111','202.84.223.21','152.63.86.6','193.251.133.124','198.71.45.14','210.7.32.1','210.7.32.2','198.71.45.15','198.71.45.16','198.71.45.17','129.250.4.251','154.54.28.33','157.130.230.81','193.251.241.121','64.86.28.74','193.251.254.114','4.69.144.203','4.69.144.202','67.17.72.13','200.0.204.5','85.95.26.206','208.48.239.70','200.0.204.6','129.250.2.168','129.250.2.169','198.71.45.9','198.71.45.7','198.71.45.8','85.95.25.213','213.248.72.10','150.99.195.253','150.99.195.254','137.164.46.51','146.97.35.182','67.16.140.189','137.164.26.245','193.251.128.25','208.48.239.69','216.156.64.85','152.179.48.17','101.4.115.225','101.4.115.226','213.155.135.82','200.0.207.9','208.178.245.10','150.99.2.102','193.251.128.37','192.31.99.218','150.99.2.106','150.99.2.105','128.139.233.2','4.69.154.201','128.139.233.1','213.155.135.86','202.112.6.70','67.16.145.49','4.69.154.200','213.155.135.88','213.248.87.90','140.247.60.1','128.139.226.1','83.167.63.244','202.112.6.69','206.223.143.96','202.84.142.157','198.32.155.206','198.71.45.4','4.69.133.101','80.81.192.13','198.71.45.6','198.71.45.5']
//var ip_list = [];
var http = require('http');

var MongoClient = require('mongodb').MongoClient
    , format = require('util').format;    

MongoClient.connect('mongodb://54.243.234.208/test', function(err, db) {
    if(err) throw err;

	//min 1328350684 to 1328379962 total 29278

/*	
	var from = 1328350684;
	var to = from + 5000;
	console.log("Finding time slices");
	db.collection('time_slices').find({},{ nodes: 1} ).toArray(function(err, results) {

		if(err) console.log("fail");
		

		for(r in results){
			var result = results[r].nodes;
			
			for(n in result){
				var node = result[n];
				if(node.network == "public")
					ip_list.push(node.ip);
			}
			
		}
		
		console.log("found "+ip_list.length);
		lookupAndTag(db,ip_list);
    });  
	*/
	
	lookupAndTag(db,ip_list);
	
});


function lookupAndTag(db, data){

	var exists = [];
	
	console.log("Retrieve existing geo locations");
	// Locate all the entries using find
    db.collection('geo').find().toArray(function(err, results) {

		for(r in results){
			var result = results[r];
			exists[result.ip]={};
			//console.log(result.ip);
		}
		
		console.log("geo tagging");
		geoTag(db, data, exists);

    });   
}
	
//data = list of public ips
function geoTag(db, data, existing){
	var collection = db.collection('geo');
	collection.ensureIndex( {"ip": 1}, {unique: true}, function(err, docs) {});
	
	var history = existing;
	var index = 0;
	
	console.log("Tagging");
	var interval = setInterval(function() { 
		
		if(index >= data.length){	
			console.log("Done");
			clearInterval(interval);
			return;
		}
		
		var ip = data[index];
		
		while( typeof history[ip] != "undefined" && index < data.length-1){
			
			index++;
			ip = data[index];
			console.log("skipping "+ip);
		}
		
		
		console.log(index + " out of "+data.length);
		console.log(ip);
		if( typeof history[ip] == "undefined" ){ //do only once per ip
			console.log("Looking up");
			// Do lookup of IP Location for public IPs
			var url = 'http://ipinfo.io/'+ip+'/json';
			console.log(url);
			http.get(url, function(res) {
			
				var body = '';
				
				res.on('data', function(chunk) {body += chunk;});

				res.on('end', function() {
					//On reciept of data
					var geoData = JSON.parse(body);
					console.log(geoData);
					history[ip] = {};
					collection.insert( geoData, {w: 1}, function(err, docs) {});
				});
				  
				 
				}).on('error', function(e) {
				  console.log("Got error: " + e.message);
			 });
			
			
			
		}
		index++;
	}, 5000); 

}